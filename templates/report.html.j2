<!DOCTYPE html>
<html>
<head>
    <title>SPECTRA EFC Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .metrics { background: #f5f5f5; padding: 20px; border-radius: 5px; }
        img { max-width: 100%; height: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Enhanced Forest Composite Report</h1>
    
    <h2>Summary</h2>
    <p>{{ summary }}</p>
    
    <h2>EFC Visualization</h2>
    <img src="efc.png" alt="Enhanced Forest Composite">
    
    <h2>Metrics</h2>
    <div class="metrics">
        <p><strong>NDVI Range:</strong> {{ "%.3f"|format(metrics.ndvi_min) }} to {{ "%.3f"|format(metrics.ndvi_max) }}</p>
        <p><strong>Mean NDVI:</strong> {{ "%.3f"|format(metrics.ndvi_mean) }}</p>
        <p><strong>C-band SAR:</strong> {{ "Yes" if metrics.has_sar_c else "No" }}</p>
        <p><strong>L-band SAR:</strong> {{ "Yes" if metrics.has_sar_l else "No" }}</p>
    </div>
    
    {% if change_metrics %}
    <h1>Change Detection Report</h1>
    
    <h2>Change Summary</h2>
    <p>{{ change_brief }}</p>
    
    <h2>Change Visualizations</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <div>
            <h3>Before</h3>
            <img src="before.png" alt="Before Image">
        </div>
        <div>
            <h3>After</h3>
            <img src="after.png" alt="After Image">
        </div>
        <div>
            <h3>NDVI Change</h3>
            <img src="delta.png" alt="NDVI Delta">
        </div>
        <div>
            <h3>Change Mask</h3>
            <img src="mask.png" alt="Change Mask">
        </div>
    </div>
    
    <h2>Change Metrics</h2>
    <div class="metrics">
        <p><strong>Changed Pixels:</strong> {{ change_metrics.changed_pixels }}</p>
        <p><strong>Area Changed:</strong> {{ "%.2f"|format(change_metrics.pct_area) }}%</p>
        <p><strong>Mean ΔNDVI:</strong> {{ "%.3f"|format(change_metrics.mean_dndvi) }}</p>
        {% if change_metrics.mean_dsar %}
        <p><strong>Mean ΔSAR:</strong> {{ "%.2f"|format(change_metrics.mean_dsar) }} dB</p>
        {% endif %}
        <p><strong>Confidence:</strong> {{ "%.2f"|format(change_metrics.confidence) }}</p>
        <p><strong>Polygons Detected:</strong> {{ change_polygons|length }}</p>
    </div>
    {% endif %}
</body>
</html>